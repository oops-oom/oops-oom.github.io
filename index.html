<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-tw">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">






<link rel="stylesheet" href="/css/main.css?v=7.2.0">






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: ''
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Know Why">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Know Why">
<meta property="og:locale" content="zh-tw">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Know Why">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>Know Why</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Know Why</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
        

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/28/TODO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="binnnliu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Know Why">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/28/TODO/" class="post-title-link" itemprop="url">写作计划</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-28 16:10:10" itemprop="dateCreated datePublished" datetime="2019-07-28T16:10:10+08:00">2019-07-28</time>
            </span>
          

          

          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Scala"><a href="#Scala" class="headerlink" title="Scala"></a>Scala</h2><ul>
<li><input disabled type="checkbox"> 泛型</li>
<li><input disabled type="checkbox"> 协变vs逆变</li>
<li><input disabled type="checkbox"> Functions in scala</li>
<li><input disabled type="checkbox"> GC</li>
</ul>
<h2 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h2><ul>
<li><input disabled type="checkbox"> golang runtime分析</li>
</ul>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><ul>
<li><input disabled type="checkbox"> HTTP2.0</li>
<li><input disabled type="checkbox"> HTTP3.0</li>
<li><input disabled type="checkbox"> HTTPS HSTS</li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><ul>
<li><input disabled type="checkbox"> Spark源码分析</li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>

    
        

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/28/for range in golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="binnnliu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Know Why">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/28/for range in golang/" class="post-title-link" itemprop="url">golang中的for range实现</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-28 15:32:29 / Modified: 16:14:21" itemprop="dateCreated datePublished" datetime="2019-07-28T15:32:29+08:00">2019-07-28</time>
            </span>
          

          
            

            
          

          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Golang中的for-range实现"><a href="#Golang中的for-range实现" class="headerlink" title="Golang中的for range实现"></a>Golang中的for range实现</h2><h3 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h3><h4 id="Code-Gist"><a href="#Code-Gist" class="headerlink" title="Code Gist"></a>Code Gist</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vals := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">valptr := <span class="built_in">make</span>([]*<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> vals &#123;</span><br><span class="line">	<span class="built_in">println</span>(k, v)</span><br><span class="line">	valptr = <span class="built_in">append</span>(valptr, &amp;v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> valptr &#123;</span><br><span class="line">	<span class="built_in">println</span>(v)</span><br><span class="line">	<span class="built_in">println</span>(*v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">0 0</span><br><span class="line">1 1</span><br><span class="line">2 2</span><br><span class="line">3 3</span><br><span class="line">4 4</span><br><span class="line">5 5</span><br><span class="line">6 6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br><span class="line">0xc000016140</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<h3 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h3><h4 id="Code-Gist-1"><a href="#Code-Gist-1" class="headerlink" title="Code Gist"></a>Code Gist</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kvs := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;</span><br><span class="line">	<span class="string">"zero"</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="string">"one"</span>:  <span class="number">1</span>,</span><br><span class="line">	<span class="string">"two"</span>:  <span class="number">2</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> kvs &#123;</span><br><span class="line">	<span class="comment">//v := v</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">"defer func(): "</span>, v)</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Output-1"><a href="#Output-1" class="headerlink" title="Output"></a>Output</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># go run main.go </span></span><br><span class="line">go func():  2</span><br><span class="line">go func():  2</span><br><span class="line">go func():  2</span><br><span class="line"><span class="comment"># go vet</span></span><br><span class="line"><span class="comment"># github.com/username/gomodule</span></span><br><span class="line">./main.go:19:27: loop variable v captured by func literal</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>出现上述两种场景的原因是:</p>
<ul>
<li>go runtime整个for循环会在第一个循环为v申请一次内存,后续循环只是修改v对应的值,v的地址不变</li>
<li>for range中, v是pass-by-value</li>
</ul>
<p>以上,场景2中,go vet会有对应的提示:</p>
<p><code>./main.go:19:27: loop variable v captured by func literal</code></p>
<p>但是场景1是没有的,讲道理这个可以算是语言的缺陷了，毕竟让用户少犯错也是语言的义务。</p>
<h3 id="Proposal"><a href="#Proposal" class="headerlink" title="Proposal"></a>Proposal</h3><p><a href="https://github.com/golang/go/issues/20733" target="_blank" rel="noopener">proposal: spec: redefine range loop variables in each iteration</a></p>
<p>已经有人提了Proposal, 预计<code>Go 2.0</code>中会彻底解决这个问题。</p>
<p>如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> vals &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>should be equivalent to</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> vals &#123;</span><br><span class="line">  k := k</span><br><span class="line">  v := v</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.ardanlabs.com/blog/2013/09/iterating-over-slices-in-go.html" target="_blank" rel="noopener">https://www.ardanlabs.com/blog/2013/09/iterating-over-slices-in-go.html</a></p>
<p><a href="https://tam7t.com/golang-range-and-pointers/" target="_blank" rel="noopener">https://tam7t.com/golang-range-and-pointers/</a></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>

    
        

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/19/分词服务socket泄漏问题查找过程记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="binnnliu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Know Why">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/19/分词服务socket泄漏问题查找过程记录/" class="post-title-link" itemprop="url">线上响应超时问题分析</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-19 01:32:29" itemprop="dateCreated datePublished" datetime="2019-03-19T01:32:29+08:00">2019-03-19</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-28 16:37:28" itemprop="dateModified" datetime="2019-07-28T16:37:28+08:00">2019-07-28</time>
              </span>
            
          

          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="线上响应超时问题分析"><a href="#线上响应超时问题分析" class="headerlink" title="线上响应超时问题分析"></a>线上响应超时问题分析</h1><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>调用分词服务的服务发现超时并告警，查看分词服务被调耗时发现一切正常；本机手动请求发现确实存在响应慢的问题。</p>
<p>重启后发现响应正常，重启线上服务，确保线上服务正常；并保留一台进行观察。</p>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>日志中只一些业务错误的记录，未发现明显导致问题的错误；</p>
<h2 id="网络问题"><a href="#网络问题" class="headerlink" title="网络问题"></a>网络问题</h2><p>由于分词服务被调耗时正常，根据经验首先是怀疑网络问题：</p>
<p>因为分词服务响应包较小，所以被调的时间是接收到请求的时间到把响应写到tcp发送缓冲区的时间,不包括网络时间。(查看Linux默认tcp写缓冲区为16K，如果响应大于16K，那么被调会包含部分网络时间，但不是全部)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#min default max, SO_SNDBUF and SO_RCVBUF 设置的最大值由net.core.wmem_max定义</span><br><span class="line">#使用SO_SNDBUF和SO_RCVBUF设置后，实际申请时会翻倍</span><br><span class="line">#为最大值net.core.wmem_max时也会翻倍</span><br><span class="line">net.ipv4.tcp_mem = 377637	503519	755274</span><br><span class="line">net.ipv4.tcp_rmem = 4096	87380	6291456</span><br><span class="line">net.ipv4.tcp_wmem = 4096	16384	4194304</span><br><span class="line"></span><br><span class="line">net.core.rmem_default = 262144  </span><br><span class="line">net.core.wmem_default = 262144 </span><br><span class="line"></span><br><span class="line"># SO_SNDBUF and SO_RCVBUF </span><br><span class="line">net.core.rmem_max = 16777216  </span><br><span class="line">net.core.wmem_max = 16777216</span><br></pre></td></tr></table></figure>

<p>查看主备调监控服务，发现网络流量没有较大的波动；<strong>暂时排除网络问题</strong>。</p>
<h2 id="服务运行情况"><a href="#服务运行情况" class="headerlink" title="服务运行情况"></a>服务运行情况</h2><p>top查看服务负载正常。没有头绪，但是运气很好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p `pidof httpseg`</span><br></pre></td></tr></table></figure>

<p>打开文件数确实挺多，很多如下条目：</p>
<p><code>httpseg 17125 webdev  149u     sock        0,6      0t0 2289696420 protocol: TCP</code></p>
<p>此处开始怀疑是不是打开的文件数超过了服务的限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ll /proc/`pidof httpseg`/fdinfo|wc -l</span><br><span class="line">1024</span><br><span class="line">cat /proc/`pidof httpseg`/limits</span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        2048                 unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             63034                63034                processes</span><br><span class="line">Max open files            1024                 1000000              files</span><br><span class="line">Max locked memory         65536                65536                bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       63034                63034                signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         0                    0</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br></pre></td></tr></table></figure>

<p>问题：too many open files </p>
<p>此处有个严重的失误：</p>
<p><strong>按理说一开始就能发现问题，但是查看日志时只看了业务日志，没有看stdout,stderr的日志，而且直到重启完所有有问题的机器，也没有看这些日志；更悲剧的是这些日志使用的是覆盖的方式，而非追加的方式，导致重启后日志全没了。</strong></p>
<p>也是在于对golang http的服务相关代码不够了解导致。</p>
<h2 id="too-many-open-files的影响"><a href="#too-many-open-files的影响" class="headerlink" title="too many open files的影响"></a>too many open files的影响</h2><p>代码细节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">for &#123;</span><br><span class="line">	rw, e := l.Accept()</span><br><span class="line">	if e != nil &#123;</span><br><span class="line">		select &#123;</span><br><span class="line">		case &lt;-srv.getDoneChan():</span><br><span class="line">			return ErrServerClosed</span><br><span class="line">		default:</span><br><span class="line">		&#125;</span><br><span class="line">		if ne, ok := e.(net.Error); ok &amp;&amp; ne.Temporary() &#123;</span><br><span class="line">			if tempDelay == 0 &#123;</span><br><span class="line">				tempDelay = 5 * time.Millisecond</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				tempDelay *= 2</span><br><span class="line">			&#125;</span><br><span class="line">			if max := 1 * time.Second; tempDelay &gt; max &#123;</span><br><span class="line">				tempDelay = max</span><br><span class="line">			&#125;</span><br><span class="line">			srv.logf(&quot;http: Accept error: %v; retrying in %v&quot;, e, tempDelay)</span><br><span class="line">			time.Sleep(tempDelay)</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		return e</span><br><span class="line">	&#125;</span><br><span class="line">	tempDelay = 0</span><br><span class="line">	c := srv.newConn(rw)</span><br><span class="line">	c.setState(c.rwc, StateNew) // before Serve can return</span><br><span class="line">	go c.serve(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://ask.qcloudimg.com/draft/1318359/k2iri4a7ox.png" alt="日志"></p>
<p><strong>打开文件数超过程序限制会导致accept失败，accept失败后会循环重试，这里的log默认是输出的stdout的。</strong></p>
<h3 id="一些延伸"><a href="#一些延伸" class="headerlink" title="一些延伸"></a>一些延伸</h3><p>accept失败会导致accept队列中的连接不能被及时取出，accept队列满了怎么办？</p>
<p><strong>三次握手产生的：sync队列和accept队列</strong></p>
<p><strong>accept是取得accept队列中的Establish状态的连接</strong></p>
<p><strong>accept-queue满了怎么办</strong></p>
<p>accept队列长度： <code>min(/proc/sys/net/core/somaxconn, backlog)</code></p>
<blockquote>
<p>The  backlog argument defines the maximum length to which the queue of pending connections for sockfd may grow.  If a connection request arrives when the queue is full, the client may receive an error with an indication of ECONNREFUSED or, if the underlying protocol supports retransmission, the request may be ignored so that a later reattempt at connection succeeds.</p>
</blockquote>
<p>默认情况下，即<code>/proc/sys/net/ipv4/tcp_abort_on_overflow</code>为0时，服务端会忽略客户端响应的ack(连接会停留在syn队列)，等待超时，服务端重新发送sync+ack给客户端(<code>net.ipv4.tcp_synack_retries</code>)；<br><code>/proc/sys/net/ipv4/tcp_abort_on_overflow</code>为1时，accept-queue满，服务端会响应rst。</p>
<p><strong>syn队列满了怎么办</strong><br><code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code></p>
<p>若SYN队列满，则会直接丢弃请求，即新的SYN网络分组会被丢弃；客户端则会超时重传syn.</p>
<blockquote>
<p>比如syn floods 攻击就是针对半连接队列的，攻击方不停地建连接，但是建连接的时候只做第一步，第二步中攻击方收到server的syn+ack后故意扔掉什么也不做，导致server上这个队列满其它正常请求无法进来</p>
</blockquote>
<p>此处没有考虑tcp_syncookies的影响</p>
<p><strong>命令查看队列满了的丢包现象</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -s | egrep <span class="string">"listen|LISTEN"</span> </span><br><span class="line">19219 <span class="built_in">times</span> the listen queue of a socket overflowed</span><br><span class="line">19234 SYNs to LISTEN sockets dropped</span><br></pre></td></tr></table></figure>

<p><img src="https://binnnliu.github.io/img/tcp.jpg" alt="[图片来自莿鸟栖草堂](https://www.cnxct.com/something-about-phpfpm-s-backlog/)"></p>
<p>too  many open files导致accept失败会重试导致响应耗时增加，同时accept失败会导致accept队列中的连接不能被及时取出，accept队列会慢；</p>
<p>accept队列满了，server端会丢弃ack，超时后server重发syn + ack，导致耗时增加；</p>
<p>syn队列慢了，server端会丢弃syn，超时后clienth会重发syn，导致耗时增加。</p>
<p>以上原因导致请求分词服务响应会慢，但是由于被调时间是从连接完成开始计算的，所以从被调上是看不出问题的。</p>
<h2 id="socket泄漏"><a href="#socket泄漏" class="headerlink" title="socket泄漏"></a>socket泄漏</h2><p>由于服务是简单的golang提供http服务，调用分词库，所以第一时间就怀疑是分词库的问题。</p>
<blockquote>
<p>业务背景：分词库会请求鉴权服务进行鉴权，鉴权失败的话，分词库是不能正常使用的。</p>
</blockquote>
<p>但是问题是，没有分词服务的源代码。如何定位？</p>
<p>最小化服务，排除干扰，只调用分词库进行分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace ./demo</span><br></pre></td></tr></table></figure>

<p><img src="https://binnnliu.github.io/img/strace01.png" alt="strace输出"></p>
<p>分析发现，确实创建了两个socket，但是只close了一个。</p>
<p>这里是采用非阻塞的方式发起连接，此处connect时，返回EINPROGRESS；</p>
<p>直接看man 2 connect:</p>
<blockquote>
<p>EINPROGRESS<br>The socket is non-blocking and the connection cannot be completed immediately. It is possible to select(2) or poll(2) for completion by selecting the socket for writing.After select(2) indicates writability, use getsockopt(2) to read the SO_ERROR option at level SOL_SOCKET to determine whether connect() completed successfully (SO_ERROR is zero) or unsuccessfully (SO_ERROR is one of the usual error codes listed here, explaining the reason for the failure).</p>
</blockquote>
<p>服务将对应的fd放入poll侦听可写状态，侦听到可写后调用getsockopt判断是连接成功还是失败。</p>
<p>第一个连接获得的SO_ERROR为110，查看errno 110 为Connection timed out;</p>
<p>问题就在这个地方，连接失败了，但是没有关闭socket！</p>
<p>第二个连接获得的SO_ERROR为0，说明连接正常，后续也正常关闭了连接。(问题已反馈给词库开发同学)</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>线上服务qps 100+的服务使用了默认的limit，不应该；</p>
</li>
<li><p>日志不应该重启就丢了，太low；</p>
</li>
<li><p>定位问题的手段：</p>
<p>日志:  没有查看标准错误日志,里面有明确的错误原因；</p>
<p>网络状况: 可以看到因为accept队列满而丢包的情况；</p>
<p>明明可以靠日志或或者现象找到问题，偏偏靠运气才找到。</p>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://jm.taobao.org/2017/05/25/525-1/" target="_blank" rel="noopener">关于TCP 半连接队列和全连接队列</a></p>
<p><a href="https://www.taohui.pub/" target="_blank" rel="noopener">高性能网络编程</a></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>

    
        

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/19/对nginx $request_time的一些理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="binnnliu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Know Why">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/03/19/对nginx $request_time的一些理解/" class="post-title-link" itemprop="url">对于nginx $request_time的一些理解</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-03-19 01:32:29" itemprop="dateCreated datePublished" datetime="2017-03-19T01:32:29+08:00">2017-03-19</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-28 16:37:28" itemprop="dateModified" datetime="2019-07-28T16:37:28+08:00">2019-07-28</time>
              </span>
            
          

          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="以前的理解"><a href="#以前的理解" class="headerlink" title="以前的理解"></a>以前的理解</h2><blockquote>
<p>$request_time是 nginx收到第一个字节 到 nginx把所有响应内容放到tcp 发送缓冲区的时间。</p>
</blockquote>
<p>很长一段时间，我都觉得上面的说法是正确的。</p>
<p>直到前两天跟同事探讨$request_time，才发现并不完全正确，才把以前的一些疑问解释了，觉得挺有意义，这里记录一下。</p>
<p>$request_time对于很多CDN厂商来说是一个十分敏感的变量，某些时候可能涉及客户对于质量的考察，当然也许只是一些不太了解$request_time变量的人。</p>
<p>Nginx文档对于$request_time的定义如下：</p>
<blockquote>
<p>request processing time in seconds with a milliseconds resolution; time elapsed since the first bytes were read from the client</p>
</blockquote>
<p>文档只介绍了何时开始计算request_time，没有说何时结束。</p>
<h2 id="新的理解"><a href="#新的理解" class="headerlink" title="新的理解"></a>新的理解</h2><p>对于开启长连接的请求处理，上面的说法是完全正确的。</p>
<p>但是对于短连接的呢？</p>
<p>大概是16年初，曾经某水果台曾使用我们公司CDN。客户使用几家CDN,对比发现我们的CDN慢速请求（byte_sent/request_time）数较多。</p>
<p>讲道理的话，这时候应该优化了。当然首先想到的肯定是sndbuf，恩，其实很多公司也确实是这么做的。</p>
<p>把sndbuf调整到2M, 果然排名靠前了不少。</p>
<p>这时候售前同学就统计了，说Http 1.0的慢速请求数还是很多。</p>
<p>sndbuf还区分协议的？</p>
<p>显然，http1.0和http1.1的一个主要区别就是http1.0默认是关闭长连接的。</p>
<p>查了下代码，发现 <code>ngx_http_finalize_connection</code>中对于是否开启长连接，走了两种不同的路径。</p>
<p>显然，开启了keep_alive，会走ngx_http_set_keepalive分支；但是，如若不开启，keepalive则有两种可能：</p>
<ol>
<li>ngx_http_close_request;</li>
<li>ngx_http_set_lingering_close; 显然调用lingering_close的话，会导致打印日志的时间推迟；</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ngx_terminate</span><br><span class="line">     &amp;&amp; !ngx_exiting</span><br><span class="line">     &amp;&amp; r-&gt;keepalive</span><br><span class="line">     &amp;&amp; clcf-&gt;keepalive_timeout &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_set_keepalive(r);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clcf-&gt;lingering_close == NGX_HTTP_LINGERING_ALWAYS</span><br><span class="line">    || (clcf-&gt;lingering_close == NGX_HTTP_LINGERING_ON</span><br><span class="line">        &amp;&amp; (r-&gt;lingering_close</span><br><span class="line">            || r-&gt;header_in-&gt;pos &lt; r-&gt;header_in-&gt;last</span><br><span class="line">            || r-&gt;connection-&gt;read-&gt;ready)))</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_set_lingering_close(r);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_http_close_request(r, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>Nginx对于epoll采用的是NGX_USE_GREEDY_EVENT策略（The event filter requires to do i/o operation until EAGAIN: epoll.）。</p>
<p>这种策略导致，在调用<code>ngx_http_finalize_connection</code>时，read-&gt;ready一直为1，从而调用ngx_http_set_lingering_close关闭连接。</p>
<p>但是这个问题在1.11.13版本，nginx引入epoll对于EPOLL_RDHUP的处理后有所改变，代码如下：</p>
<p><a href="https://github.com/nginx/nginx/commit/12f436718963f8343e38ad6d0e8f7251c95984cd#diff-fbb307b8718d9152c5dc4563247f5349" target="_blank" rel="noopener">nginx diff</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123; <span class="comment">//读取到的字节数为0，表示对端关闭连接</span></span><br><span class="line">            rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">            rev-&gt;eof = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_EPOLLRDHUP)</span></span><br><span class="line">            <span class="keyword">if</span> ((ngx_event_flags &amp; NGX_USE_EPOLL_EVENT)</span><br><span class="line">                &amp;&amp; ngx_use_epoll_rdhup)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; size) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!rev-&gt;pending_eof) &#123;</span><br><span class="line">                        rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    rev-&gt;available = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> n;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">size_t</span>) n &lt; size</span><br><span class="line">                &amp;&amp; !(ngx_event_flags &amp; NGX_USE_GREEDY_EVENT)) </span><br><span class="line">            &#123;</span><br><span class="line">                rev-&gt;ready = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">        err = ngx_socket_errno;</span><br><span class="line">        <span class="keyword">if</span> (err == NGX_EAGAIN || err == NGX_EINTR) &#123;</span><br><span class="line">            ngx_log_debug0(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">                           <span class="string">"recv() not ready"</span>);</span><br><span class="line">            n = NGX_AGAIN;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            n = ngx_connection_error(c, err, <span class="string">"recv() failed"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>所以对于nginx 1.11.13之后的版本，无论是否开启keepalive上述的结论仍然是正确的。</p>
<p>对于之前版本，如果想避免lingering_close，可以在配置项中<code>lingering_close off</code>。</p>
<h2 id="TCP-Socket对于linger-close的支持"><a href="#TCP-Socket对于linger-close的支持" class="headerlink" title="TCP Socket对于linger close的支持"></a>TCP Socket对于linger close的支持</h2><p>close(l_onoff=0缺省状态):在套接口上不能在发出发送或接收请求;套接口发送缓冲区中的内容被发送到对端.如果描述字引用计数变为0;在发送完发送缓冲区中的数据后,跟以正常的TCP连接终止序列(发送FIN);套接口接受缓冲区中内容被丢弃。</p>
<p>close(l_onoff = 1, l_linger =0):在套接口上不能再发出发送或接受请求,如果描述子引用计数变为0,RST被发送到对端;连接的状态被置为CLOSED(没有TIME_WAIT状态),套接口发送缓冲区和套接口接受缓冲区的数据被丢弃。</p>
<p>close(l_onoff =1, l_linger != 0):在套接口上不能在发出发送或接收请求;套接口发送缓冲区中的内容被发送到对端.如果描述字引用计数变为0;在发送完发送缓冲区中的数据后,跟以正常的TCP连接终止序列(发送FIN);套接口接受缓冲区中内容被丢弃;如果在连接变成CLOSED状态前延滞时间到,那么close返回EWOULDBLOCK错误。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>

    
        

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/19/epoll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="binnnliu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Know Why">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/03/19/epoll/" class="post-title-link" itemprop="url">两篇微博引发的思考</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-03-19 01:32:29" itemprop="dateCreated datePublished" datetime="2014-03-19T01:32:29+08:00">2014-03-19</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-28 16:37:28" itemprop="dateModified" datetime="2019-07-28T16:37:28+08:00">2019-07-28</time>
              </span>
            
          

          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="导语"><a href="#导语" class="headerlink" title="导语"></a>导语</h3><p>前段时间微博上注意到[叔度] <a href="http://weibo.com/tshudu" target="_blank" rel="noopener">7</a>，发了两篇关于面试的微博：</p>
<blockquote>
<p>一些小伙伴们写网络程序的一个坏习惯是连接建立后就挂上可写事件，这是很浪费的。正确的方法是先写，写不下去才挂上可写事件。另外，可写事件其实不是事件，它只是判断发送缓冲区是否还有空间，它是被底层的TCP事件给附带上来的。附图是Linux内核源码实现。<img src="https://binnnliu.github.io/img/sendbufevent.jpg" alt="enter image description here"></p>
</blockquote>
<blockquote>
<p>对于非阻塞的connect，返回EINPROGRESS之后要加fd到epoll的可写事件监视集合里面，等fd可写了之后记得要调用getsockopt判断SOL_SOCKET的SO_ERROR值是否为0！非0表示连接失败。</p>
</blockquote>
<h3 id="EPOLL使用"><a href="#EPOLL使用" class="headerlink" title="EPOLL使用"></a>EPOLL使用</h3><ul>
<li>ET  only noblocking mode<pre><code>处理方式：</code></pre><ul>
<li>读:只要可读，就一直读，直到返回0，或者 errno = EAGAIN</li>
<li>写:只要可写，就一直写，直到数据发送完，或者 errno = EAGAIN</li>
</ul>
</li>
<li>LT</li>
</ul>
<p>分析:一旦建立链接就挂可写事件(noblocking mode)：</p>
<ul>
<li>若在ET模式下，其实还好,相比与LT模式。哈..</li>
<li>若在LT模式下，将会不停的触发！</li>
</ul>
<h3 id="Nginx的实现"><a href="#Nginx的实现" class="headerlink" title="Nginx的实现"></a>Nginx的实现</h3><p>如何做呢。正如叔度所说，先写，直到errno=EAGIN。挂载写事件，在epoll的驱动下完成全部内容的发送。当然nginx就是这么实现的。ngx_http_write，但是LT模式下，需不需要触发后从epoll中移出此可写事件呢。</p>
<p>问题：<br>    nginx使用了何种触发方式？<br>listen的socket用的水平触发，而accept之后的端口使用的是边沿触发。为何这么麻烦呢?<br>1.listen的fd使用水平触发是因为害怕丢失链接；其实使用边沿触发也有解决办法：用while循环抱住accept调用，处理完TCP就绪队列中的所有连接后再退出循环。nginx有个配置选项：[multi_accept] <a href="http://nginx.org/en/docs/ngx_core_module.html#multi_accept" target="_blank" rel="noopener">6</a>,这是为啥？莫非是为了减少epoll_wait的系统调用?<br>2.使用ET可以有效的减少系统调用，但是ET，LT哪种更高效，貌似没用确切的结论。[ET理论上可以比LT少带来一些系统调用，所以更省一些。具体的性能提高有多少，要看应用场景。不过绝大部分场景下，LT是足够的。] <a href="http://www.zhihu.com/question/20502870" target="_blank" rel="noopener">4</a> </p>
<p>nginx水平触发代码如下：若nginx配置[accept_mutex] <a href="http://nginx.org/en/docs/ngx_core_module.html#accept_mutex" target="_blank" rel="noopener">5</a> on时会调用如下函数  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_enable_accept_events(<span class="keyword">ngx_cycle_t</span> *cycle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>         i;</span><br><span class="line">    <span class="keyword">ngx_listening_t</span>   *ls;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    ls = cycle-&gt;listening.elts;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cycle-&gt;listening.nelts; i++) &#123;</span><br><span class="line"></span><br><span class="line">        c = ls[i].connection;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;read-&gt;active) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_event_flags &amp; NGX_USE_RTSIG_EVENT) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ngx_add_conn(c) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_add_event(c-&gt;read, NGX_READ_EVENT, <span class="number">0</span>) == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一道面试题目：<br>使用Linux epoll模型，水平触发模式；当socket可写时，会不停的触发socket可写的事件，如何处理？</p>
<p>另一个问题：</p>
<p>直接看man 2 connect:</p>
<blockquote>
<p>EINPROGRESS<br>The socket is non-blocking and the connection cannot be completed immediately.  It is possible to select(2) or poll(2) for completion by selecting the socket for writing.After select(2) indicates writability, use getsockopt(2) to read the SO_ERROR option at level SOL_SOCKET to determine whether connect()  completed  successfully  (SO_ERROR  is zero) or unsuccessfully (SO_ERROR is one of the usual error codes listed here, explaining the reason for the failure).</p>
</blockquote>
<p>但是为什么呢？不成功也会返回可写事件？这是必须的。不管成功或者失败，总需要给client端一个交代吧。</p>
<h3 id="缓冲区"><a href="#缓冲区" class="headerlink" title="缓冲区"></a>缓冲区</h3><p>发送缓冲区(send buffer)<br>ex:发送一个14M的buffer–公司客户端某些同事，就是在nonblocking模式下发送14m文件的，而且他就send了一次。<br>1.block模式下，等待所有的buffer发送完后返回。block方式有可能返回小于buffer长度的值么？嗯，是的。在对方异常关闭或超时是会造成返回小于buffer长度的值如果对端返回rst时，继续写的话会产生SIGPIPE,这里需要特别注意，因为sigpipe默认处理是关闭进程！一般情况下，需要捕捉此信号；<br>2.noblocking模式下，若返回值为-1，errno=EAGAIN,则加入侦听；若返回值为大于0,则循环继续发送；</p>
<p>这个要说下nginx：<br>当然如果发送文件的话，nginx用的sendfile。<br>sendfile的好处是啥呢？减少copy次数。<br>这里必须要解释下copy为啥费时费力的：<br><strong>copy一般情况下需要cpu,寄存器,一次只能copy 32bit,所以一个指令周期只能copy 32bit。</strong>所以出现了DMA,sendbuf,splice,cow等技术。nginx在upstream也做了优化。具体见：[代理服务器中的内容防拷贝技术] <a href="http://blog.csdn.net/brainkick/article/details/9843009" target="_blank" rel="noopener">2</a> ,也因此有了面试题目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span> *src,<span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//如何实现更快...</span></span><br><span class="line">    <span class="comment">//可以转为int *类型这个，一个指令周期就可以最大化的copy</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就有了内存对齐。写到这里忽然想起另一个无关的东西:RingBuffer的实现，里面有个[cache_line_padding] <a href="http://ifeve.com/disruptor-cacheline-padding/" target="_blank" rel="noopener">3</a> 跟这个有异曲同工之妙，不过跟copy无关是关于无锁队列的。可是sendfile就好了么？nginx还有更深层的优化。正常情况下，nginx是设置tcp_nodelay;但是在sendfile时，会设置tcp_cork。</p>
<p>在传输文件时，我们可以做那些优化呢？</p>
<p>接收缓冲区(read buffer)<br>    epoll返回可写事件，调用recv返回0，则表示对端关闭。对端close，若拔网线呢？keepalive情况下会触发可写事件。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>

    
        

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/10/Hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="binnnliu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Know Why">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/03/10/Hexo/" class="post-title-link" itemprop="url">Hexo搭建Blog记录</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-03-10 01:32:29" itemprop="dateCreated datePublished" datetime="2014-03-10T01:32:29+08:00">2014-03-10</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-28 16:10:10" itemprop="dateModified" datetime="2019-07-28T16:10:10+08:00">2019-07-28</time>
              </span>
            
          

          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Hexo-101"><a href="#Hexo-101" class="headerlink" title="Hexo 101"></a>Hexo 101</h1><h2 id="Install-nodejs"><a href="#Install-nodejs" class="headerlink" title="Install nodejs"></a>Install nodejs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Just For Linux</span></span><br><span class="line">wget https://npm.taobao.org/mirrors/node/v10.16.0/node-v10.16.0-linux-x64.tar.gz</span><br><span class="line">tar xzvf node-v10.16.0-linux-x64.tar.gz </span><br><span class="line">mv node-v10.16.0-linux-x64 /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"PATH=<span class="variable">$PATH</span>:/usr/local/node-v10.16.0-linux-x64/bin"</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"><span class="comment"># check if success</span></span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<h2 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h2><h3 id="Install-Hexo"><a href="#Install-Hexo" class="headerlink" title="Install Hexo"></a>Install Hexo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set proxy if needed</span></span><br><span class="line">npm config <span class="built_in">set</span> http-proxy http://devnet-proxy.oa.com:8080</span><br><span class="line">npm config <span class="built_in">set</span> https-proxy http://devnet-proxy.oa.com:8080</span><br><span class="line"></span><br><span class="line">npm install -g hexo-cli</span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">hexo init blog</span><br><span class="line">hexo serve -p 80</span><br></pre></td></tr></table></figure>

<p>source 目录存放了_posts和img,额外的仓库进行版本管理,所以发布之前需要拉取最新文章列表;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deploy</span></span><br><span class="line"><span class="built_in">cd</span> blog/<span class="built_in">source</span></span><br><span class="line">git pull</span><br><span class="line">hexo generate</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure>

<h3 id="Theme"><a href="#Theme" class="headerlink" title="Theme"></a>Theme</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">blog</span></span><br><span class="line"><span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/hexo-theme-next</span> <span class="string">themes/next</span></span><br></pre></td></tr></table></figure>

<h3 id="Setting"><a href="#Setting" class="headerlink" title="Setting"></a>Setting</h3><p>_config.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Site</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Know</span> <span class="string">Why</span></span><br><span class="line"><span class="attr">subtitle:</span></span><br><span class="line"><span class="attr">description:</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">binnnliu</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">en</span></span><br><span class="line"><span class="attr">timezone:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extensions</span></span><br><span class="line"><span class="comment">## Plugins: https://hexo.io/plugins/</span></span><br><span class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/binnnliu/binnnliu.github.io.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<h3 id="Git-Setting"><a href="#Git-Setting" class="headerlink" title="Git Setting"></a>Git Setting</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># linux下git保存用户名密码</span><br><span class="line">cd ~</span><br><span class="line">touch .git-credentials</span><br><span class="line">git config --global credential.helper store </span><br><span class="line"># 下次登录会记录用户名密码</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>

    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">binnnliu</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    

    

    
      
      
      <div class="site-state-item site-state-tags">
        
        
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span>
        
      </div>
    
  </nav>







  <div class="links-of-author motion-element">
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/binnnliu" title="GitHub &rarr; https://github.com/binnnliu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
  </div>







          
          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">binnnliu</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    

  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
















  
  









  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  


  























<script>
// GET RESPONSIVE HEIGHT PASSED FROM IFRAME

window.addEventListener("message", function(e) {
  var data = e.data;
  if ((typeof data === 'string') && (data.indexOf('ciu_embed') > -1)) {
    var featureID = data.split(':')[1];
    var height = data.split(':')[2];
    $(`iframe[data-feature=${featureID}]`).height(parseInt(height) + 30);
  }
}, false);
</script>








  

</body>
</html>
